// === DATA BAHASA (HANYA UI, KESAN/PESAN SISWA DIAMBIL DARI HTML) ===
const translations = {
    id: {
        mainTitle: "Kenang-kenangan Kelas 9G",
        graduationYear: "Angkatan 2024-2025", // GANTI TAHUN
        schoolName: "SMPN 32 Semarang",      // GANTI NAMA SEKOLAH
        clickHint: "(Klik pada foto siswa untuk melihat pesan mereka)",
        schoolLogoAlt: "Logo SMPN 32 Semarang", // GANTI NAMA SEKOLAH
        schoolBuildingAlt: "Gedung SMPN 32 Semarang", // GANTI NAMA SEKOLAH
        welcomeToSchoolMemories: "Selamat Datang di Kenangan SMPN 32 Semarang", // GANTI NAMA SEKOLAH
        memoriesBeginHere: "Tempat di mana cerita kita dimulai dan kenangan indah terukir.",
        welcomeTo9GPage: "Selamat datang di halaman kenangan",
        clickFriendPhoto: "Klik foto temanmu untuk membaca pesan dan kesan mereka.",
        memoriesWithStudents: "Kenangan indah ini tercipta bersama",
        studentsText: "siswa",
        greatStudents: "hebat",
        homeroomTeacher: "Wali Kelas",
        viewGroupPhotosButton: "Lihat Daftar Foto Bersama", // Tombol di index.html
        galleryPageTitle: "Galeri Foto Bersama Kelas 9G", // Judul di galeri.html
        backToMainPageButton: "&laquo; Kembali ke Halaman Utama", // Tombol di galeri.html
        groupPhotosTitle: "Foto-foto Kenangan Bersama", // Judul galeri di galeri.html
        classPhotoAlt1: "Foto Bersama 1", // Untuk alt text foto bersama
        classPhotoCaption1: "[Isi Keterangan Foto Bersama 1 - ID]", // Untuk caption foto bersama
        classPhotoAlt2: "Foto Bersama 2",
        classPhotoCaption2: "[Isi Keterangan Foto Bersama 2 - ID]",
        classPhotoAlt3: "Foto Bersama 3",
        classPhotoCaption3: "[Isi Keterangan Foto Bersama 3 - ID]",
        classPhotoAlt4: "Foto Bersama 4",
        classPhotoCaption4: "[Isi Keterangan Foto Bersama 4 - ID]",
        classPhotoAlt5: "Foto Bersama 5",
        classPhotoCaption5: "[Isi Keterangan Foto Bersama 5 - ID]",
        classPhotoAlt6: "Foto Bersama 6",
        classPhotoCaption6: "[Isi Keterangan Foto Bersama 6 - ID]",
        classPhotoAlt7: "Foto Bersama 7",
        classPhotoCaption7: "[Isi Keterangan Foto Bersama 7 - ID]",
        classPhotoAlt8: "Foto Bersama 8",
        classPhotoCaption8: "[Isi Keterangan Foto Bersama 8 - ID]",
        classPhotoAlt9: "Foto Bersama 9",
        classPhotoCaption9: "[Isi Keterangan Foto Bersama 9 - ID]",
        classPhotoAlt10: "Foto Bersama 10",
        classPhotoCaption10: "[Isi Keterangan Foto Bersama 10 - ID]",
        classPhotoAlt11: "Foto Bersama 11",
        classPhotoCaption11: "[Isi Keterangan Foto Bersama 11 - ID]",
        classPhotoAlt12: "Foto Bersama 12",
        classPhotoCaption12: "[Isi Keterangan Foto Bersama 12 - ID]",
        classPhotoAlt13: "Foto Bersama 13",
        classPhotoCaption13: "[Isi Keterangan Foto Bersama 13 - ID]",
        classPhotoAlt14: "Foto Bersama 14",
        classPhotoCaption14: "[Isi Keterangan Foto Bersama 14 - ID]",
        classPhotoAlt15: "Foto Bersama 15",
        classPhotoCaption15: "[Isi Keterangan Foto Bersama 15 - ID]",
        classPhotoAlt16: "Foto Bersama 16",
        classPhotoCaption16: "[Isi Keterangan Foto Bersama 16 - ID]",
        classPhotoAlt17: "Foto Bersama 17",
        classPhotoCaption17: "[Isi Keterangan Foto Bersama 17 - ID]",
        classPhotoAlt18: "Foto Bersama 18",
        classPhotoCaption18: "[Isi Keterangan Foto Bersama 18 - ID]",
        classPhotoAlt19: "Foto Bersama 19",
        classPhotoCaption19: "[Isi Keterangan Foto Bersama 19 - ID]",
        studentGalleryTitle: "Galeri Siswa Kelas 9G",
        settingsTitle: "Pengaturan Tampilan",
        languageLabel: "Bahasa:",
        acrylicEffectLabel: "Efek Transparan (Acrylic):",
        toggleThemeButton: "Ubah ke Tema Gelap",
        settingsButton: "Pengaturan",
        schoolNameFooter: "SMPN 32 Semarang", // GANTI NAMA SEKOLAH
        madeWithLove: "Dibuat dengan",
        modalKesanLabel: "Kesan:",
        modalPesanLabel: "Pesan:",
        modalNoMessage: "Belum ada pesan atau kesan dari siswa ini."
    },
    en: { // LENGKAPI SEMUA TERJEMAHAN UNTUK BAHASA INGGRIS
        mainTitle: "Class 9G Memories",
        graduationYear: "Graduating Class of 2024-2025", // GANTI TAHUN
        schoolName: "SMPN 32 Semarang", // GANTI NAMA SEKOLAH
        clickHint: "(Click on a student's photo to see their message)",
        schoolLogoAlt: "SMPN 32 Semarang Logo", // GANTI NAMA SEKOLAH
        schoolBuildingAlt: "SMPN 32 Semarang Building", // GANTI NAMA SEKOLAH
        welcomeToSchoolMemories: "Welcome to SMPN 32 Semarang Memories", // GANTI NAMA SEKOLAH
        memoriesBeginHere: "The place where our stories began and beautiful memories were made.",
        welcomeTo9GPage: "Welcome to the Class 9G memories page",
        clickFriendPhoto: "Click on your friend's photo to read their messages and impressions.",
        memoriesWithStudents: "Beautiful memories created with",
        studentsText: "students",
        greatStudents: "great",
        homeroomTeacher: "Homeroom Teacher",
        viewGroupPhotosButton: "View Group Photo Gallery",
        galleryPageTitle: "Class 9G Group Photo Gallery",
        backToMainPageButton: "&laquo; Back to Main Page",
        groupPhotosTitle: "Group Memory Photos",
        classPhotoAlt1: "Group Photo 1",
        classPhotoCaption1: "[Translate Group Photo Caption 1 to EN]",
        classPhotoAlt2: "Group Photo 2",
        classPhotoCaption2: "[Translate Group Photo Caption 2 to EN]",
        // ... Translate all 19 captions and alt texts
        classPhotoAlt19: "Group Photo 19",
        classPhotoCaption19: "[Translate Group Photo Caption 19 to EN]",
        studentGalleryTitle: "Class 9G Student Gallery",
        settingsTitle: "Display Settings",
        languageLabel: "Language:",
        acrylicEffectLabel: "Transparent Effect (Acrylic):",
        toggleThemeButton: "Switch to Dark Theme",
        settingsButton: "Settings",
        schoolNameFooter: "SMPN 32 Semarang", // GANTI NAMA SEKOLAH
        madeWithLove: "Made with",
        modalKesanLabel: "Impressions:",
        modalPesanLabel: "Messages:",
        modalNoMessage: "No message or impression from this student yet."
    },
    ms: { // LENGKAPI SEMUA TERJEMAHAN UNTUK BAHASA MELAYU
        mainTitle: "Kenangan Kelas 9G",
        graduationYear: "Angkatan 2024-2025", // GANTI TAHUN
        schoolName: "SMPN 32 Semarang", // GANTI NAMA SEKOLAH
        clickHint: "(Klik pada foto pelajar untuk melihat mesej mereka)",
        schoolLogoAlt: "Logo SMPN 32 Semarang", // GANTI NAMA SEKOLAH
        schoolBuildingAlt: "Bangunan SMPN 32 Semarang", // GANTI NAMA SEKOLAH
        welcomeToSchoolMemories: "Selamat Datang ke Kenangan SMPN 32 Semarang", // GANTI NAMA SEKOLAH
        memoriesBeginHere: "Tempat di mana cerita kita bermula dan kenangan indah terukir.",
        welcomeTo9GPage: "Selamat datang ke halaman kenangan Kelas 9G",
        clickFriendPhoto: "Klik foto rakan anda untuk membaca mesej dan kesan mereka.",
        memoriesWithStudents: "Kenangan indah tercipta bersama",
        studentsText: "pelajar",
        greatStudents: "hebat",
        homeroomTeacher: "Guru Kelas",
        viewGroupPhotosButton: "Lihat Galeri Foto Bersama",
        galleryPageTitle: "Galeri Foto Bersama Kelas 9G",
        backToMainPageButton: "&laquo; Kembali ke Halaman Utama",
        groupPhotosTitle: "Foto-foto Kenangan Bersama",
        classPhotoAlt1: "Foto Bersama 1",
        classPhotoCaption1: "[Terjemahkan Keterangan Foto Bersama 1 ke MS]",
        classPhotoAlt2: "Foto Bersama 2",
        classPhotoCaption2: "[Terjemahkan Keterangan Foto Bersama 2 ke MS]",
        // ... Terjemahkan semua 19 caption dan alt text
        classPhotoAlt19: "Foto Bersama 19",
        classPhotoCaption19: "[Terjemahkan Keterangan Foto Bersama 19 ke MS]",
        studentGalleryTitle: "Galeri Pelajar Kelas 9G",
        settingsTitle: "Tetapan Paparan",
        languageLabel: "Bahasa:",
        acrylicEffectLabel: "Kesan Lutsinar (Akrilik):",
        toggleThemeButton: "Tukar ke Tema Gelap",
        settingsButton: "Tetapan",
        schoolNameFooter: "SMPN 32 Semarang", // GANTI NAMA SEKOLAH
        madeWithLove: "Dibuat dengan",
        modalKesanLabel: "Kesan:",
        modalPesanLabel: "Mesej:",
        modalNoMessage: "Belum ada mesej atau kesan daripada pelajar ini."
    }
};

document.addEventListener('DOMContentLoaded', function () {
    const htmlElement = document.documentElement;
    const themeToggleButton = document.getElementById('themeToggle');
    const settingsButton = document.getElementById('settingsButton');
    const settingsPanel = document.getElementById('settingsPanel');
    const closeSettingsPanelButton = document.getElementById('closeSettingsPanel');
    const languageSelector = document.getElementById('languageSelector');
    const acrylicToggle = document.getElementById('acrylicToggle');

    const studentCards = document.querySelectorAll('.student-card');
    const modal = document.getElementById('studentModal');
    const modalImg = document.getElementById('modalImg');
    const modalName = document.getElementById('modalName');
    const modalMessage = document.getElementById('modalMessage');
    const closeModalButton = modal ? modal.querySelector('.close-button') : null;

    let currentTheme = localStorage.getItem('theme') || 'light';
    let currentLang = localStorage.getItem('language') || 'id';
    let acrylicEnabled = JSON.parse(localStorage.getItem('acrylicEnabled')) === true;

    function applyTheme(theme) {
        htmlElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        currentTheme = theme;
        updateThemeButtonText();
    }

    function updateThemeButtonText() {
        const langPack = translations[currentLang] || translations.id;
        let baseText;
        if (currentTheme === 'dark') {
            if (currentLang === 'id') baseText = "Ubah ke Tema Terang";
            else if (currentLang === 'ms') baseText = "Tukar ke Tema Cerah";
            else baseText = "Switch to Light Theme";
        } else {
            if (currentLang === 'id') baseText = "Ubah ke Tema Gelap";
            else if (currentLang === 'ms') baseText = "Tukar ke Tema Gelap";
            else baseText = "Switch to Dark Theme";
        }
        if(themeToggleButton) themeToggleButton.textContent = baseText;
    }

    function setLanguage(lang) {
        if (!translations[lang]) {
            console.warn(`Language pack for "${lang}" not found. Defaulting to 'id'.`);
            lang = 'id';
        }
        htmlElement.lang = lang;
        currentLang = lang;
        localStorage.setItem('language', lang);
        const langPack = translations[lang];

        let schoolNameTextDefault = "[Nama Sekolah Kamu]";
        const schoolNameElementHeader = document.querySelector('.header-text p span[data-translate="schoolName"]');
        if (schoolNameElementHeader) {
            const parts = schoolNameElementHeader.textContent.split("|");
            if (parts.length > 0) schoolNameTextDefault = parts[0].trim();
        } else if (langPack.schoolName && !langPack.schoolName.includes("[GANTI")) {
             schoolNameTextDefault = langPack.schoolName;
        }


        let graduationYearTextDefault = "[Tahun Lulus Kamu]";
        const graduationYearElementHeader = document.querySelector('.header-text p span[data-translate="graduationYear"]');
        if (graduationYearElementHeader) {
            const parts = graduationYearElementHeader.textContent.split("|");
            if (parts.length > 1) graduationYearTextDefault = parts[1].trim().replace("Angkatan ","").replace("Graduating Class of ","");
            else if (parts.length > 0 && (parts[0].includes("Angkatan") || parts[0].includes("Class of"))) {
                graduationYearTextDefault = parts[0].replace("Angkatan ","").replace("Graduating Class of ","").trim();
            }
        } else if (langPack.graduationYear && !langPack.graduationYear.includes("[GANTI")) {
            graduationYearTextDefault = langPack.graduationYear.replace("Angkatan ","").replace("Graduating Class of ","").trim();
        }


        document.querySelectorAll('[data-translate], [data-translate-alt], [data-translate-aria]').forEach(el => {
            const key = el.dataset.translate || el.dataset.translateAlt || el.dataset.translateAria;
            let translatedText = langPack[key];

            if (translatedText !== undefined) {
                translatedText = translatedText.replace(/\[GANTI NAMA SEKOLAH\]/g, schoolNameTextDefault);
                translatedText = translatedText.replace(/\[GANTI TAHUN LULUS\]/g, graduationYearTextDefault);
                // Ganti placeholder lain jika ada di dalam string terjemahan
                translatedText = translatedText.replace(/\[Isi Keterangan Foto Bersama \d+ - (ID|EN|MS)\]/g, (match) => {
                    // Jika placeholder keterangan foto belum diisi di translations, gunakan teks asli dari HTML figcaption
                    const figcaptionElement = el.closest('figure')?.querySelector('figcaption');
                    return (figcaptionElement && !figcaptionElement.textContent.startsWith("[")) ? figcaptionElement.textContent : match;
                });


                if (el.hasAttribute('data-translate-aria')) {
                    el.setAttribute('aria-label', translatedText);
                } else if (el.hasAttribute('data-translate-alt') || (el.tagName === 'IMG' && key.endsWith('Alt'))) {
                     el.alt = translatedText;
                } else {
                    el.innerHTML = translatedText;
                }
            } else {
                 // console.warn(`Translation key "${key}" not found for language "${lang}" in element:`, el);
            }
        });
        updateThemeButtonText();
    }

    function applyAcrylicEffect(isEnabled) {
        htmlElement.setAttribute('data-acrylic', isEnabled ? 'true' : 'false');
        localStorage.setItem('acrylicEnabled', JSON.stringify(isEnabled));
        acrylicEnabled = isEnabled;
    }

    if (studentCards.length > 0 && modal && closeModalButton) {
        function openStudentModal(card) {
            const nama = card.dataset.nama;
            const foto = card.dataset.foto;
            const kesanText = card.dataset.kesan || "";
            const pesanText = card.dataset.pesan || "";
            const quoteText = card.dataset.quote || "";

            modalImg.src = foto;
            const studentNameForAlt = nama.startsWith("[NAMA SISWA") ? "Siswa" : nama;
            modalImg.alt = `Foto ${studentNameForAlt}`;
            modalName.textContent = nama;

            let messageHTML = '';
            const langPack = translations[currentLang] || translations.id;

            if (kesanText.trim() !== "" && !kesanText.startsWith("[KESAN SISWA")) {
                messageHTML += `<p><strong>${langPack.modalKesanLabel || 'Kesan:'}</strong> ${kesanText}</p>`;
            }
            if (pesanText.trim() !== "" && !pesanText.startsWith("[PESAN SISWA")) {
                messageHTML += `<p><strong>${langPack.modalPesanLabel || 'Pesan:'}</strong> ${pesanText}</p>`;
            }
            if (quoteText.trim() !== "" && !quoteText.startsWith("[QUOTE SISWA")) {
                messageHTML += `<p><em>"${quoteText}"</em></p>`;
            }

            if (messageHTML.trim() === "") {
                messageHTML = `<p><em>${langPack.modalNoMessage || 'Belum ada pesan atau kesan dari siswa ini.'}</em></p>`;
            }
            modalMessage.innerHTML = messageHTML;

            modal.classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeStudentModal() {
            modal.classList.remove('active');
            if (!settingsPanel || !settingsPanel.classList.contains('active')) {
                document.body.classList.remove('modal-open');
            }
        }

        studentCards.forEach(card => {
            const clickableElement = card.querySelector('img, .placeholder-img');
            if (clickableElement) clickableElement.addEventListener('click', () => openStudentModal(card));
        });
        closeModalButton.addEventListener('click', closeStudentModal);
    }

    // Event Listeners Umum
    if (themeToggleButton) themeToggleButton.addEventListener('click', () => applyTheme(currentTheme === 'light' ? 'dark' : 'light'));
    if (settingsButton && settingsPanel && closeSettingsPanelButton) {
        settingsButton.addEventListener('click', () => { settingsPanel.classList.add('active'); document.body.classList.add('modal-open'); });
        closeSettingsPanelButton.addEventListener('click', () => {
            settingsPanel.classList.remove('active');
            if (!modal || !modal.classList.contains('active')) document.body.classList.remove('modal-open');
        });
    }
    if (languageSelector) languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));
    if (acrylicToggle) acrylicToggle.addEventListener('change', (e) => applyAcrylicEffect(e.target.checked));

    window.addEventListener('click', function (event) {
        if (modal && event.target === modal) closeStudentModal(); // Hanya jika modal ada
        if (settingsPanel && event.target === settingsPanel) {
            settingsPanel.classList.remove('active');
            if (!modal || !modal.classList.contains('active')) document.body.classList.remove('modal-open');
        }
    });
    window.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            if (settingsPanel && settingsPanel.classList.contains('active')) {
                settingsPanel.classList.remove('active');
                if (!modal || !modal.classList.contains('active')) document.body.classList.remove('modal-open');
            } else if (modal && modal.classList.contains('active')) closeStudentModal();
        }
    });

    // Apply initial settings
    applyTheme(currentTheme);
    setLanguage(currentLang);
    if(languageSelector) languageSelector.value = currentLang;
    if(acrylicToggle) {
        applyAcrylicEffect(acrylicEnabled);
        acrylicToggle.checked = acrylicEnabled;
    }
});